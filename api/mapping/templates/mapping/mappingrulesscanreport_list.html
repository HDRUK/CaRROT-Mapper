{% extends "base.html" %}

{% block body %}



<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'scan-report-list' %}">Scan
            reports</a></li>
        <li class="breadcrumb-item">
          <a href="{% url 'tables' %}?search={{ scan_report.id }}">   {{ scan_report.data_partner.name }} - {{ scan_report.dataset }} </a>
	</li>
    </ol>
</nav>


<h2>Mapping Rules</h2>

<form method="post">{% csrf_token %}
  <button type="submit" class="btn btn-success" name='refresh-rules' >Refresh Rules</button>
  <button type="submit" class="btn btn-danger" name='delete-rules' >Delete Rules</button>
  <button type="submit" class="btn btn-info" name='download-rules' >Download Mapping JSON</button>
  <button type="button" class="btn btn-warning" name='view-rules' id='view_svg' >View Map Diagram</button>

</form>


<hr>

{% if object_list %}

<div class="container-fluid p-2" style='background-color: #3db28c11;'>

  <div class="row">
    <div class="col-sm">
      <!---
 <h6>Filter On Destination Table</h6>
     
      <a href="url 'tables-structural-mapping' pk=scan_report.id " class="btn btn-info"> All </a>

	  for omop_table in omop_tables
        <a href="e url 'tables-structural-mapxping-filter-lvl1' pk=scan_report.id omop_table=omop_table " class="btn btn-info">  omop_table </a>
	endfor
	--->

    </div>
  {% if source_tables %}
    <div class="col-sm">
      <h6>Filter On Source Table</h6>
      {% for source_table in source_tables %}
       <a href="{% url 'tables-structural-mapping-filter-lvl2' pk=scan_report.id omop_table=filtered_omop_table source_table=source_table %}" class="btn btn-dark"> {{ source_table }} </a>
       {% endfor %}
    </div>
       {% endif %}
  </div>
</div>
       

 
  <div class="container">
  <div class="row mx-auto" id='placeholder-svg'>
  </div>
  <div class="row">
    
    <table class="table">
    <thead>
    <tr>
        <!--<th scope="col">Data Partner</th>
        <th scope="col">Dataset</th>-->
        <th scope="col">Destination Table</th>
        <th scope="col">Destination Field</th>
	<th scope="col">Source Table</th>
	<th scope="col">Source Field</th>
	<th scope="col">Term Map</th>
	<!---<th scope="col">Operation</th>--->
	<!---<th scope="col">Approved</th>--->
    </tr>
    </thead>
    <tbody>
      {% for object in object_list.iterator %}
      <tr>
        <td style="width: 16.6%">{{ object.omop_field.table.table }}</td>
        <td style="width: 16.6%">{{ object.omop_field.field }}</td>
	<td style="width: 16.6%">
	  <a href="{% url 'fields' %}?search={{ object.source_field.scan_report_table.id }}"> {{object.source_field.scan_report_table.name}} </a>
	</td>
	
        <td style="width: 16.6%">
	  <a href="{% url 'values' %}?search={{ object.source_field.id }}"> {{object.source_field.name}} </a>
	</td>

        <td style="width: 16.6%">
	  <span class="text-danger">
	    {% if object.concept.content_object.value %}
	    "{{ object.concept.content_object.value }}"
	    {% endif %}
	  </span>

	  <i class="fas fa-long-arrow-alt-right"></i>
	  <span class="text-success">
	    "{{ object.concept.concept_id }}"
	    </span> <br>
	  ( {{ object.concept.concept.concept_name }} )
	  <!---<a href="{% url 'scan_report_value_concept-delete' %}?scan_report_field_id={{ value.content_object.scan_report_field.id }}&scan_report_concept_id={{ value.concept_id }}">(delete)</a>
	   --->
	  
	</td>
      </tr>
      {% endfor %}
    </tbody>
    </table>
  </div>
  </div>

{% endif %}

  
  <script>
    $("#view_svg").click(function () {

	  //retrieve the div text
	  var button_text = $(this).text();
	  // if the buttons says View and has been clicked
	  // then change it to a hide button
	  if (button_text.includes('View')){
		button_text = button_text.replace("View","Hide");
	  }
	  //vice versa
	  else{
		button_text = button_text.replace("Hide","View");
	  }
	  //set the next button text depending on click action
	  $(this).text(button_text);

	  //if we dont have an svg image 
	  if ($('#placeholder-svg').find("svg").length == 0) {

		var spinner = `
                      <div class="spinner-border mx-auto" role="status">
		      <span class="sr-only">Loading...</span>
		      </div>`;
		$('#placeholder-svg').append(spinner);
		
		//use ajax to post a request to retrieve one
	  	$.ajax({
		      type: "POST",
		      url: window.location,
		      data: {
			    'get-svg': true,
			    'csrfmiddlewaretoken': '{{ csrf_token }}',
		      },
		      success: function (data) {
			    var data = $("svg", data);
			    $('#placeholder-svg').empty();
			    $('#placeholder-svg').append(data);
			    
		      },
		      error: function(XMLHttpRequest, textStatus, errorThrown){
			    $('#placeholder-svg').html(errorThrown);
		      }
		});
	  }
	  else{
		//otherwise if we already have the image cached
		//toggle the display
		$("#placeholder-svg").toggleClass('d-none');
	  }
	  
    });


    // $("select[name*='source_table']").each(function(i, obj) {
    // 	  //$("select[name*='source_']").each(function(i, obj) {
    // 	  var options = $(this).find("option");
	  
    // 	  options.detach().sort(function(a,b) {
    // 		var at = $(a).text().toLowerCase();
    // 		var bt = $(b).text().toLowerCase();         
    // 		return (at > bt)?1:((at < bt)?-1:0);  
    // 	  });
    // 	  options.appendTo(obj); 
    // });

    //force people to save the table after changing select box
    //important for source_table, need to refresh changes for source_field
    //e.g. if source_table changed to gender, need to update source_field values
    $("select[name*='source_table']").change(function(){
	  $("#table_save_btn").click();
    });
    
    
    $("#id_omop_table").change(function () {
	  var url = $("#mappingRuleForm").attr("data-omop-fields-url");  
	  var omop_table_id = $(this).val();  
	  
	  $.ajax({
		url: url,                
		data: {
		      'omop_table': omop_table_id 
		},
		success: function (data) {   
		      $("#id_omop_field").html(data);  
		}
	  });
	  
    });

    
  </script>


{% endblock %}

