{% extends "base.html" %}

{% block body %}



<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'scan-report-list' %}">Scan
            reports</a></li>
        <li class="breadcrumb-item">
          <a href="{% url 'tables' %}?search={{ scan_report.id }}">   {{ scan_report.data_partner.name }} - {{ scan_report.dataset }} </a>
	</li>
    </ol>
</nav>

<div class="container" id="output">
	<div id='root'></div>
    <script type="text/javascript" >
        var csrfmiddlewaretoken = "{{csrf_token}}"
		var a = "{{a}}"
        var u = "{{u}}"

		// To get the mappings from the python
		const list ="{{object_list}}".replaceAll("&#x27;",'"').replaceAll("&lt;",'{"').replaceAll("&gt;",'}').replaceAll('"term_mapping": None','"term_mapping": null')
		var mappings = ''
		for(let i=0;i<list.length;i++){
			if(list[i]==":"&&list[i-1]!='"'){
				mappings += '"'
			}
			mappings += list[i]
		}
		//


		var s = document.createElement("script");
        s.type = "module";
		s.innerHTML = null;
		if(window.location.href.split("mapping_rules/")[1].split("/").length>1){
            s.src = "../../../../static/javascript/react/src/mappingRules.js";
		}
		else{
            s.src = "../../../static/javascript/react/src/mappingRules.js";
		}
		document.getElementsByTagName('head')[0].appendChild(s)


		var refreshRules = async function () {
			//use ajax to post a request to retrieve one
			const res = await $.ajax({
				type: "POST",
				url: window.location,
				data: {
					'refresh_rules': true,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
				}
			});
			return res;
		}

		var analyseConcepts = async function () {
			//use ajax to post a request to retrieve one
			const res = await $.ajax({
				type: "POST",
				url: window.location,
				data: {
					'analyse_concepts': true,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
				}
			});
			return res;
		}

		var getSVG = async function () {
			const response = await $.ajax({
				type: "POST",
				url: window.location,
				data: {
					'get_svg': true,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
				}
			});
			return response
		}

		var downloadImage = async function (svg) {
			
			var serializer = new XMLSerializer();
			var source = serializer.serializeToString(svg);
			//add name spaces.
			if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
				source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
			}
			if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
				source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
			}

			//add xml declaration
			source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

			//convert svg source to URI data scheme.
			var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);
			var element = document.createElement("a");
			element.download = "diagram.svg";
			element.href = url
			element.click();
			element.remove();
			return "Download successful"
			
		}

		var downloadRules = function (setDownloading) {
			setDownloading(true)
			$.ajax({
				type: "POST",
				url: window.location,
				data: {
					'download_rules': true,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
				},
				success: function (response, status, xhr) {
					$('#spinner').addClass('d-none');

					//https://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post
					var type = xhr.getResponseHeader('Content-Type');
					var blob = new Blob([JSON.stringify(response, null, 6)], { type: type });

					// check for a filename
					var filename = "";
					var disposition = xhr.getResponseHeader('Content-Disposition');
					if (disposition && disposition.indexOf('attachment') !== -1) {
						var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
						var matches = filenameRegex.exec(disposition);
						if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
					}


					if (typeof window.navigator.msSaveBlob !== 'undefined') {
						// IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
						window.navigator.msSaveBlob(blob, filename);
					}
					else {
						var URL = window.URL || window.webkitURL;
						var downloadUrl = URL.createObjectURL(blob);
						if (filename) {
							// use HTML5 a[download] attribute to specify filename
							var a = document.createElement("a");
							// safari doesn't support this yet
							if (typeof a.download === 'undefined') {
								window.location.href = downloadUrl;
							}
							else {
								a.href = downloadUrl;
								a.download = filename;
								document.body.appendChild(a);
								a.click();
							}
						}
						else {
							window.location = downloadUrl;
						}
						setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup

					}
					setDownloading(false)
				},
				error: function (XMLHttpRequest, textStatus, errorThrown) {
					//$('#spinner').html(errorThrown);
					setDownloading(false)
					alert("Could not download rules")
				}
			});
		}


		var downloadCSV = function (setDownloading) {
			setDownloading(true)
			$.ajax({
				type: "POST",
				url: window.location,
				data: {
					'download_rules_as_csv': true,
					'csrfmiddlewaretoken': '{{ csrf_token }}',
				},
				success: function (response, status, xhr) {
					$('#spinner').addClass('d-none');

					//https://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post
					var type = xhr.getResponseHeader('Content-Type');
				        var blob = new Blob([response], { type: type });

					// check for a filename
					var filename = "";
					var disposition = xhr.getResponseHeader('Content-Disposition');
					if (disposition && disposition.indexOf('attachment') !== -1) {
						var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
						var matches = filenameRegex.exec(disposition);
						if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
					}


					if (typeof window.navigator.msSaveBlob !== 'undefined') {
						// IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
						window.navigator.msSaveBlob(blob, filename);
					}
					else {
						var URL = window.URL || window.webkitURL;
						var downloadUrl = URL.createObjectURL(blob);
						if (filename) {
							// use HTML5 a[download] attribute to specify filename
							var a = document.createElement("a");
							// safari doesn't support this yet
							if (typeof a.download === 'undefined') {
								window.location.href = downloadUrl;
							}
							else {
								a.href = downloadUrl;
								a.download = filename;
								document.body.appendChild(a);
								a.click();
							}
						}
						else {
							window.location = downloadUrl;
						}
						setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup

					}
					setDownloading(false)
				},
				error: function (XMLHttpRequest, textStatus, errorThrown) {
					//$('#spinner').html(errorThrown);
					setDownloading(false)
					alert("Could not download rules")
				}
			});
		}
    </script>
</div>




{% endblock %}

