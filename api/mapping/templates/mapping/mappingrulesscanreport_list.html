{% extends "base.html" %}

{% block body %}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'scan-report-list' %}">Scan
            reports</a></li>
        <li class="breadcrumb-item">
            {{ scan_report.data_partner }} - {{ scan_report.dataset }}</li>
    </ol>
</nav>



<h2>Mapping Rules</h2>

<form method="post">{% csrf_token %}
  <button type="submit" class="btn btn-success" name='generate' >Generate Mapping Rules</button>
  <button type="submit" class="btn btn-info" name='download-sm' >Download Mapping JSON</button>
  <button type="button" id='view_svg' class="btn btn-warning" name='download-sm' >View Map Diagram</button>
</form>


<hr>
{% if object_list %}
<h6>Filter On Destination Table</h6>
<button type="submit" class="btn btn-info" name='generate' >
  <a href="{% url 'tables-structural-mapping' pk=scan_report.id %}" style="color:#ffffff; text-decoration: none;"> All </a> 
</button>

 {% for omop_table in omop_tables %}
 <button type="submit" class="btn btn-info" name='generate' >
   <a href="{% url 'tables-structural-mapping-filter' pk=scan_report.id omop_table=omop_table %}" style="color:#ffffff; text-decoration: none;"> {{ omop_table }} </a>
  </button> 
{% endfor %}
{% endif %}

{% if object_list %}

 
  <div class="container">
  <div class="row mx-auto" id='placeholder-svg'>
  </div>
  <div class="row">
    
    <form id="my_form" method="post">
      {% csrf_token %}
      {{ formset.management_form }}
    <table class="table">
    <thead>
    <tr>
        <!--<th scope="col">Data Partner</th>
        <th scope="col">Dataset</th>-->
        <th scope="col">Destination Table</th>
        <th scope="col">Destination Field</th>
	<th scope="col">Source Table</th>
	<th scope="col">Source Field</th>
	<th scope="col">Term Map</th>
	<th scope="col">Approved</th>
    </tr>
    </thead>
    <tbody>
      {% for object in object_list %}
      <tr>
        <!--- <td style="width: 25%">{{ object.omop_field. }}</td>--->
        <td style="width: 16.6%">{{ object.omop_field.table }}</td>
        <td style="width: 16.6%">{{ object.omop_field.field }}</td>
	<!-- <td style="width: 16.6%"> -->
	<!--   {## set i to be the index of the value we're on ##}  -->
        <!--   {% with i=forloop.counter %} -->
        <!--   {## loop over the formset (editable fields) ##} -->
        <!--   {% for form in formset  %} -->
        <!--     {% if forloop.counter == i%} -->
        <!--      {% for field in form %} -->
	<!--          {% if field.label == 'Source table' %} -->
        <!--            {{field}} -->
	<!--          {% endif %} -->
        <!--       {% endfor %}  -->
        <!--     {% endif %} -->
        <!--   {% endfor %} -->
	<!--   {% endwith %} -->
	
        <td style="width: 16.6%">
	  {## set i to be the index of the value we're on ##} 
          {% with i=forloop.counter %}
          {## loop over the formset (editable fields) ##}
          {% for form in formset  %}
            {% if forloop.counter == i%}
             {% for field in form %}
	           <td> {{field}} <br> {{ field.label}} </td>
	     {% endfor %} 
            {% endif %}
          {% endfor %}
	  {% endwith %}
	  
        <td style="width: 16.6%">
	  {% if object.term_mapping != "null" %}
	  {{ object.term_mapping }}
	  {% endif %}
	</td>
	<!-- <td style="width: 16.6%"> -->
 <!-- {## set i to be the index of the value we're on ##}  -->
 <!--          {% with i=forloop.counter %} -->
 <!--          {## loop over the formset (editable fields) ##} -->
 <!--          {% for form in formset  %} -->
 <!--            {% if forloop.counter == i%} -->
 <!--             {% for field in form %} -->
 <!-- 	         {% if field.label == 'Approved' %} -->
 <!--                   {{field}} -->
 <!-- 	         {% endif %} -->
 <!--              {% endfor %}  -->
 <!--            {% endif %} -->
 <!--          {% endfor %} -->
 <!-- 	  {% endwith %} -->
	</td>
      </tr>
      {% endfor %}
    </tbody>
</table>
  </div>
</div>

<button type="submit" class="btn btn-primary">Save</button>
</form>

{% else %}
<p>There are currently no rules for this scan report.</p>
{% endif %}

{% if object_list %}
<form method="post">{% csrf_token %}
  <button type="submit" class="btn btn-danger" name='clean' >Delete All</button>

  <!---
  <button type="submit" class="btn btn-info" name='download-tm' >Download Term Mapping</button>
  --->
  <!---
  <button type="submit" class="btn btn-info" name='download-pk' >Download Person ID Mapping</button>
  --->
</form>
{% endif %}



  <script>
    $("#view_svg").click(function () {

	  $.ajax({
		type: "POST",
		url: window.location,
		data: {
		      'svg': true,
		      'csrfmiddlewaretoken': '{{ csrf_token }}',
		},
		success: function (data) {
		      var data = $("svg", data);
		      $('#placeholder-svg').append(data);
		},
		error: function(XMLHttpRequest, textStatus, errorThrown){
		      $('#placeholder-svg').html(errorThrown);
		}
	  });

    
    });
  </script>


{% endblock %}

